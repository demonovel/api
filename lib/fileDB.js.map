{"version":3,"file":"fileDB.js","sourceRoot":"","sources":["fileDB.ts"],"names":[],"mappings":";;AAAA,+BAAqC;AACrC,uCAAgD;AAEhD,IAAI,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,WAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,cAAO,CAAC,SAAS,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAC;AAEpH,SAAS,SAAS,CAAC,UAAkB;IAEpC,OAAO,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,CAAA;AACxC,CAAC;AAED,IAAI,EAAE,GAAG,eAAe,CAAC;AAEzB,SAAS,WAAW,CAAC,MAAc,EAAE,MAAc;IAElD,IAAI,UAAU,GAAG,cAAO,CAAC,SAAS,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;IAEpD,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,EAChE;QACC,MAAM,IAAI,KAAK,CAAC,WAAW,MAAM,MAAM,MAAM,GAAG,CAAC,CAAA;KACjD;IAED,OAAO,UAAU,CAAA;AAClB,CAAC;AAED,kBAAe;IACd,KAAK,CAAC,GAAG,CAAC,MAAc,EAAE,MAAc;QAEvC,OAAO,mBAAQ,CAAC,WAAW,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC,CAAA;IAC7C,CAAC;IACD,KAAK,CAAC,GAAG,CAAC,MAAc,EAAE,MAAc,EAAE,IAAS;QAElD,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,EACvB;YACC,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,SAAS,CAAC,GAAG,IAAI,eAAe,CAAC,CAAC,CAAC;SAC7D;QAED,OAAO,qBAAU,CAAC,WAAW,CAAC,MAAM,EAAE,MAAM,CAAC,EAAE,IAAI,CAAC;aAClD,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,CACf;IACH,CAAC;CACD,CAAA","sourcesContent":["import { resolve, join } from \"path\";\nimport { readJSON, outputJSON } from 'fs-extra';\n\nlet cacheRoot = process.env.IS_REMOTE ? join('/tmp', '.cache', 'file') : resolve(__dirname, '..', '.cache', 'file');\n\nfunction checkPath(targetPath: string)\n{\n\treturn targetPath.startsWith(cacheRoot)\n}\n\nlet re = /[^a-z0-9_\\-]/i;\n\nfunction resolvePath(siteID: string, hashID: string)\n{\n\tlet targetPath = resolve(cacheRoot, siteID, hashID);\n\n\tif (!checkPath(targetPath) || re.test(siteID) || re.test(hashID))\n\t{\n\t\tthrow new Error(`不合法的請求 '${siteID}' '${hashID}'`)\n\t}\n\n\treturn targetPath\n}\n\nexport default {\n\tasync get(siteID: string, hashID: string)\n\t{\n\t\treturn readJSON(resolvePath(siteID, hashID))\n\t},\n\tasync set(siteID: string, hashID: string, data: any)\n\t{\n\t\tif (!data || !data.href)\n\t\t{\n\t\t\treturn Promise.reject(new TypeError(`${data} is not allow`));\n\t\t}\n\n\t\treturn outputJSON(resolvePath(siteID, hashID), data)\n\t\t\t.then(e => data)\n\t\t\t;\n\t},\n}\n"]}